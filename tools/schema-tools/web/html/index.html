<html>
<head>
    <!-- OpenMIDIRealtimeSpecification.js generated by QuickType -->
    <script src="../js/OpenMIDIRealtimeSpecification.js"></script>
    <style>
        body {
            font-family: "Helvetica";
        }
    </style>
</head>
<body>
<input type="file" id="files" name="file" />
<br><br>
<button id="showHideButton" onclick="toggleInfoVisibility();" style="display: none;">Show Details</button>
<div id="specDetails" style="display: none;"></div>
<div id="controls" style="display: none;"></div>

</div>
<script>
    var indent = 0;

    function appendObjectEntries(obj) {
        var newStr = "";

        for (let [key, value] of Object.entries(obj)) {
            if (typeof value !== 'undefined' && !(Array.isArray(value) && value.length <= 0)) {
                if (typeof value === 'object') {
                    var prepend = "";

                    if (indent > 0) {
                        for (var i=0; i<indent; i++) {
                            prepend += "&nbsp;&nbsp;";
                        }
                    }
                    indent++;
                    newStr += "<br>" + prepend + "<strong>" + key + ":</strong> ";
                    newStr += appendObjectEntries(value);
                    indent--;
                } else {
                    var prepend = "";

                    if (indent > 0) {
                        for (var i=0; i<indent; i++) {
                            prepend += "&nbsp;&nbsp;";
                        }
                    }
                    newStr += "<br>" + prepend + "<strong>" + key + ":</strong> ";
                    newStr += value;
                }
            }
        }

        return newStr;
    }

    function wireControls(spec) {
        var str = "";

        for (var i=0; i<spec.controlChangeCommands.length; i++) {
            var param = spec.controlChangeCommands[i];
            str += "<br>" + param.name + ": <input type=\"range\" id=\"cc_" +
                param.controlChangeNumber +
                "\" min=\"" + param.valueRange.min +
                "\" max=\"" + param.valueRange.max +
                "\" value=\"" + param.valueRange.min +
                "\" />";
        }

        document.getElementById('controls').innerHTML = str;
        document.getElementById('controls').style.display = "block";
    }

    function processSpec(spec) {
        var str = "<br><strong>Spec Info</strong>";

        str += "<br>" + appendObjectEntries(spec);

        document.getElementById('specDetails').innerHTML = str;
        document.getElementById("showHideButton").style.display = "block";

        wireControls(spec);
    }

    function handleFileSelect(evt) {
        const files = evt.target.files;

        for (var i = 0, f; f = files[i]; i++) {
            const reader = new FileReader();
            reader.onload = (function(reader) {
                return function() {
                    const contents = reader.result;
                    const parsed = toOpenMIDIRealtimeSpecification(contents);
                    processSpec(parsed);
                }
            })(reader);

            reader.readAsText(f);
        }
    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);

    function toggleInfoVisibility() {
        const div = document.getElementById("specDetails");
        const btn = document.getElementById("showHideButton");

        if (div.style.display === "none") {
            div.style.display = "block";
            btn.innerHTML = "Hide Details";
        } else {
            div.style.display = "none";
            btn.innerHTML = "Show Details";
        }
    }
</script>
</body>
</html>