<html>
<head>
    <!-- OpenMIDIRealtimeSpecification.js generated by QuickType -->
    <script src="../js/OpenMIDIRealtimeSpecification.js"></script>
    <style>
        body {
            font-family: "Helvetica";
        }
    </style>
</head>
<body>
<h3>Schema Tools - Web MIDI</h3>
Connect one or more MIDI devices to your computer and choose a file that adheres to the Open MIDI Realtime Control Schema<br><br>
<input type="file" id="files" name="file" />
<br><br>
<button id="showHideButton" onclick="toggleInfoVisibility();" style="display: none;">Show Details</button>
<div id="specDetails" style="display: none;"></div>
<div id="controls" style="display: none;"></div>

</div>
<script>
    const ccStatus = 176; // CC status byte value

    var indent = 0; // formatting
    var outputs = []; // midi outputs
    var channel = 1;  // midi channel

    function onMIDISuccess(midiAccess) {
        console.log(midiAccess);

        midiAccess.outputs.forEach(
            function(port, key) {
                outputs.push(port);
            }
        );

        console.log(outputs);

        midiAccess.onstatechange = function(e) {
            console.log(e.port.name, e.port.manufacturer, e.port.state);

            if (e.port.type == "output" && e.port.state == "connected") {
                console.log("Connect output");
                outputs.push(e.port);
            } else if (e.port.type == "output" && e.port.state == "disconnected") {
                console.log("Disconnect output");

                var indexesToRemove = [];
                for (var i=0; i<outputs.length; i++) {
                    if (outputs[i].name == e.port.name) {
                        indexesToRemove.push(i);
                    }
                }

                if (indexesToRemove.length > 0) {
                    for (var i=0; i<indexesToRemove.length; i++) {
                        outputs.splice(indexesToRemove[i], 1);
                    }
                }
            }
        };
    }

    function onMIDIFailure() {
        console.log('Failed to connect to MIDI devices');
    }

    function handleSliderChange(ccNumber, value) {
        document.getElementById("cc_" + ccNumber + "_output").innerHTML = value;

        var messageArr = [ccStatus + (channel - 1)].concat([ccNumber, parseInt(value)]);

        for (var i=0; i<outputs.length; i++) {
            const output = outputs[i];
            if (output.state == "connected") {
                console.log("sending MIDI: " + messageArr + " to: " + output.name);
                output.send(messageArr);
            }
        }
    }

    function appendObjectEntries(obj) {
        var newStr = "";

        for (let [key, value] of Object.entries(obj)) {
            if (typeof value !== 'undefined' && !(Array.isArray(value) && value.length <= 0)) {
                if (typeof value === 'object') {
                    var prepend = "";

                    if (indent > 0) {
                        for (var i=0; i<indent; i++) {
                            prepend += "&nbsp;&nbsp;";
                        }
                    }
                    indent++;
                    newStr += "<br>" + prepend + "<strong>" + key + ":</strong> ";
                    newStr += appendObjectEntries(value);
                    indent--;
                } else {
                    var prepend = "";

                    if (indent > 0) {
                        for (var i=0; i<indent; i++) {
                            prepend += "&nbsp;&nbsp;";
                        }
                    }
                    newStr += "<br>" + prepend + "<strong>" + key + ":</strong> ";
                    newStr += value;
                }
            }
        }

        return newStr;
    }

    function wireControls(spec) {
        var str = "";

        for (var i=0; i<spec.controlChangeCommands.length; i++) {
            var param = spec.controlChangeCommands[i];
            str += "<br>" + param.name + ": <input type=\"range\" id=\"cc_" +
                param.controlChangeNumber +
                "\" min=\"" + param.valueRange.min +
                "\" max=\"" + param.valueRange.max +
                "\" value=\"" + param.valueRange.min +
                "\" oninput=\"handleSliderChange(" + param.controlChangeNumber + ", this.value);\"/>&nbsp;&nbsp;";
            str += "<span id=\"cc_" + param.controlChangeNumber + "_output\"></span>";
        }

        document.getElementById('controls').innerHTML = str;
        document.getElementById('controls').style.display = "block";
    }

    function processSpec(spec) {
        var str = "<br><strong>Spec Info</strong>";

        str += "<br>" + appendObjectEntries(spec);

        document.getElementById('specDetails').innerHTML = str;
        document.getElementById("showHideButton").style.display = "block";

        wireControls(spec);
    }

    function handleFileSelect(evt) {
        const files = evt.target.files;

        for (var i = 0, f; f = files[i]; i++) {
            const reader = new FileReader();
            reader.onload = (function(reader) {
                return function() {
                    const contents = reader.result;
                    const parsed = toOpenMIDIRealtimeSpecification(contents);
                    processSpec(parsed);
                }
            })(reader);

            reader.readAsText(f);
        }
    }

    function toggleInfoVisibility() {
        const div = document.getElementById("specDetails");
        const btn = document.getElementById("showHideButton");

        if (div.style.display === "none") {
            div.style.display = "block";
            btn.innerHTML = "Hide Details";
        } else {
            div.style.display = "none";
            btn.innerHTML = "Show Details";
        }
    }

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
    navigator.requestMIDIAccess()
        .then(onMIDISuccess, onMIDIFailure);
</script>
</body>
</html>